---
title: "Web mapping and web apps for soil data"
author: "P. Roudier"
date: "26 June 2017"
output: 
  html_document:
    toc: true
    toc_float: true 
    theme: yeti
---

```{r libs, message=FALSE, warning=FALSE, results='hide'}
library(sf)
library(raster)
library(dplyr)

library(mapview)
library(RColorBrewer)
```

# Datasets

For this demonstration, we are using the `cookfarm` dataset from the `GSIF` package. This dataset is a list with 6 somponents storing various measurements that have been done on the farm.

```{r data}
data('cookfarm', package = "GSIF")

names(cookfarm)
```

## Vector data

The `profiles` component stores soil profile data as a `data.frame`. We will turn this into a simple feature using the `sf` package:

```{r format_data_profiles, message=FALSE, warning=FALSE}
profiles <- cookfarm$profiles %>% 
  st_as_sf(
    coords = c('Easting', 'Northing'), 
    crs = cookfarm$proj4string
  )

# simple plot using the sf package
plot(profiles)
```


## Raster data

The `grids` component is storing gridded data. We will reansform these into a `RasterStack` using the `rasterFromXYZ` function. This function requires the `x` and `y` columns to be the first column of the `data.frame` (from the left) -- a good opportunity to use the `select` function from the `dplyr` package:

```{r format_data_grids, message=FALSE, warning=FALSE}
grids <- cookfarm$grids %>% 
  dplyr::select(x, y, DEM, TWI, Cook_fall_ECa, Cook_spr_ECa) %>%  # Re-order the columns, and select 4 interesting variables
  rasterFromXYZ(crs = cookfarm$proj4string) # The coordinate reference system is stored as one of the component in cookfarm

# simple plot using the raster package
plot(grids)
```

# Interactive maps using `mapview`

## Let's start easy... 

### Vector data

The `mapview` package is basically a wrapper around the `leaflet` package.

It makes is very easy to create a `leaflet` map:

```{r mapview_simple, warning=FALSE}
# couldn't be easier to create a map!
mapview(profiles)
```

But while the `mapview` function can be called just as is, there's numerous details that can be tweaked. For example the colours:

```{r mapview_palette, warning=FALSE}
# Create palettes 
pal_continuous <- colorRampPalette(brewer.pal(7, "BrBG")) # For continuous data
pal_categorical <- colorRampPalette(brewer.pal(9, "Set1")) # For categorical data

# Pass the palette to mapview
mapview(
  profiles, 
  zcol = "TAXSUSDA", 
  col.regions = pal_categorical, 
  legend = TRUE
)
```

```{r mapview_back}
# Tweaking backgrounds
mapview(profiles, zcol = "BLD", col.regions = pal_continuous, legend = TRUE, map.types = "Esri.WorldImagery")
```

```{r mapview_burst}
# Burst to separate soil classes
mapview(profiles, zcol = "TAXSUSDA", col.regions = pal_categorical, legend = TRUE, burst = TRUE)
```

### Raster data

```{r mapview_grids}
# Plot grids
mapview(grids)
mapview(grids, col.regions = pal_continuous, na.color = "transparent",  legend = TRUE)
mapview(grids$TWI, col.regions = pal_continuous, na.color = "transparent", legend = TRUE)
```

### Satellite data

```{r mapview_sat}
# Raster specific functions
viewRGB(poppendorf)
viewRGB(poppendorf, 4, 3, 2)
```

### Changing default options

```{r options}
mapviewOptions(
  basemaps = c("Esri.WorldImagery", "Thunderforest.Landscape"),
  na.color = "transparent"
)

mapview(profiles, zcol = "BLD") + mapview(grids$DEM)
```

### Adding `mapviews` together

```{r mapview_both}
# Plot both together
mapview(grids$DEM, col.regions = pal_continuous, legend = TRUE) + mapview(profiles, zcol = "TAXSUSDA", col.regions = pal_categorical)
```

### Visualising projected data

```{r plainview, eval=FALSE}
plainview(grids$DEM)
```


## Advanced tools

### Sync'ing maps

```{r mapview_sync, eval=FALSE}
# Syncing several maps
m1 <- mapview(grids$DEM) 
m2 <- mapview(grids$TWI) 
m3 <- mapview(grids$Cook_fall_ECa)

sync(m1, m2, m3, ncol = 2, sync.cursor = TRUE)
```

This is an interactive analogue to the panelled graphs provided by `ggplot2` or `lattice`.

### Slideview

```{r slideview, eval=FALSE}
img1 <- poppendorf[[1]]
img2 <- poppendorf[[5]]

slideview(
  img1, 
  img2,
  label1 = "Poppendorf-Layer-1",
  label2 = "Poppendorf-Layer-2",
  legend = TRUE
)
```

### Popups

```{r advanced_mapview_1}
mapview(
  profiles, 
  popup = popupImage('https://www.vcard.wur.nl/WebServices/GetMedia.ashx?id=37263')
)
```

# Advanced `mapview`

```{r advanced_mapview_2, eval=FALSE}
library(xts)
library(dygraphs)

profiles$SOURCEID <- as.character(profiles$SOURCEID)

records <- cookfarm$readings
records$SOURCEID <- as.character(records$SOURCEID)

ids <- unique(records$SOURCEID)

# Subset sensors
ids <- sample(ids, size = 5) 
  
idx_sensors <- which(profiles$SOURCEID %in% ids)
sensors <- profiles[idx_sensors,]

make_ts <- function(id) {
  
  records %>% 
    filter(SOURCEID == id) %>% 
    dplyr::select(-SOURCEID) %>%
    dplyr::select(Date, ends_with('VW')) %>% 
    xts(.$Date)
}

make_dygraph <- function(id){
  ts <- make_ts(id)
  dygraph(ts)
} 

l_graphs <- lapply(
  ids,
  make_dygraph
)
```

```{r dygraph, eval=FALSE}
make_dygraph(ids[1])
```

```{r result_mapview_dygraph, eval=FALSE}
mapview(sensors, popup = popupGraph(graphs = l_graphs, width = 300, height = 300))
```